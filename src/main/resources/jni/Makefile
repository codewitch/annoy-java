## TODO: make build more cross platform
## take all look at: https://github.com/xerial/snappy-java/blob/master/Makefile.common
## and http://stackoverflow.com/a/12099167


UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Linux)
	JAVA_HOME :=/usr/lib/jvm/default-java
	JNIFLAGS  :=-I $(JAVA_HOME)/include -I ${JAVA_HOME}/include/linux
endif
ifeq ($(UNAME_S),Darwin)
    JAVA_HOME :=$(shell /usr/libexec/java_home)
    JNIFLAGS  :=-I $(JAVA_HOME)/include -I $(JAVA_HOME)/include/darwin
endif

JAVAH     :=$(JAVA_HOME)/bin/javah


CC        :=g++ -std=c++11
CFLAGS    :=-I. -I../annoy/src -I.. -lc -shared
FASTFLAGS :=-O3 -march=native -ffast-math -fPIC
SOBJ      :=libannoy.jnilib
SOURCE    :=com_spotify_annoy_AnnoyIndexImpl.cpp com_spotify_annoy_FaissImpl.cpp
HEADER    :=com_spotify_annoy_AnnoyIndexImpl.h
HEADER2   :=com_spotify_annoy_FaissImpl.h

all: annoy

annoy:
	$(JAVAH) -cp ../ -o ./$(HEADER) -jni com.spotify.annoy.AnnoyIndexImpl
	$(JAVAH) -cp ../ -o ./$(HEADER2) -jni com.spotify.annoy.FaissImpl
	$(CC) $(CFLAGS) $(JNIFLAGS) $(FASTFLAGS) -o $(SOBJ) $(SOURCE)

